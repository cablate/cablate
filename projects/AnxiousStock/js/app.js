import{formatCurrency,formatPercentage,getProfitLossClass}from"./utils.js";import{loadSettings,saveSettings,setupSettingsEventListeners}from"./settings.js";import{showEmojiPopup}from"./emojiPopup.js";import{recordLiquidation,getLiquidationHistory}from"./playHistory.js";import{initStatistics,setupStatsButton}from"./statistics.js";import{showSummaryImage}from"./summaryImage.js";document.addEventListener("DOMContentLoaded",(()=>{const e={stockChart:document.getElementById("stockChart"),currentValueEl:document.getElementById("currentValue"),profitLossEl:document.getElementById("profitLoss"),profitLossPercentageEl:document.getElementById("profitLossPercentage"),settingsBtn:document.getElementById("settingsBtn"),statsBtn:document.getElementById("statsBtn"),settingsModal:document.getElementById("settingsModal"),saveSettingsBtn:document.getElementById("saveSettingsBtn"),closeSettingsBtn:document.getElementById("closeSettingsBtn"),initialAmountInput:document.getElementById("initialAmount"),colorSchemeSelect:document.getElementById("colorScheme"),themeModeSelect:document.getElementById("themeMode"),technicalIndicatorSelect:document.getElementById("technicalIndicator"),resetBtn:document.getElementById("resetBtn"),chartLegend:document.getElementById("chartLegend"),generateCandleBtn:document.getElementById("generateCandleBtn"),currentPriceEl:document.getElementById("currentPrice"),openPriceEl:document.getElementById("openPrice"),closePriceEl:document.getElementById("closePrice"),highPriceEl:document.getElementById("highPrice"),lowPriceEl:document.getElementById("lowPrice"),priceChangeEl:document.getElementById("priceChange"),resetConfirmModal:document.getElementById("resetConfirmModal"),resetProfitLoss:document.getElementById("resetProfitLoss"),resetProfitLossPercentage:document.getElementById("resetProfitLossPercentage"),resetCandleCount:document.getElementById("resetCandleCount"),confirmResetBtn:document.getElementById("confirmResetBtn"),cancelResetBtn:document.getElementById("cancelResetBtn"),resetMessageNegative:document.getElementById("resetMessageNegative"),resetMessagePositive:document.getElementById("resetMessagePositive"),resetMessageZero:document.getElementById("resetMessageZero")},t={initialInvestment:1e6,currentValue:1e6,stockPrice:100,shares:1e4,candles:[],colorScheme:"redGreen",themeMode:"light",maxCandles:20,volatility:.02,technicalIndicator:"none",chart:null,candleSeries:null,indicatorSeries:null,indicatorMiddleSeries:null,indicatorLowerSeries:null,totalClicks:0};function n(){t.candles=[],e.generateCandleBtn.textContent="開始",t.currentValue=t.initialInvestment,t.stockPrice=100,t.shares=t.initialInvestment/t.stockPrice,t.totalClicks=0,s(),a()}function s(){e.currentValueEl.textContent=formatCurrency(t.currentValue);const n=t.currentValue-t.initialInvestment;e.profitLossEl.textContent=formatCurrency(n);const s=n/t.initialInvestment*100;e.profitLossPercentageEl.textContent=`(${formatPercentage(s)})`;const a=getProfitLossClass(n);e.profitLossEl.className="value "+a,e.profitLossPercentageEl.className="value percentage "+a,e.currentValueEl.className="value "+a,0===t.candles.length?(e.resetBtn.disabled=!0,e.resetBtn.classList.add("disabled")):(e.resetBtn.disabled=!1,e.resetBtn.classList.remove("disabled"))}function a(){if(e.stockChart.innerHTML="",t.chart=LightweightCharts.createChart(e.stockChart,{width:e.stockChart.clientWidth,height:e.stockChart.clientHeight,layout:{background:{color:"dark"===t.themeMode?"#333":"#ffffff"},textColor:"dark"===t.themeMode?"#ffffff":"#333"},grid:{vertLines:{color:"dark"===t.themeMode?"rgba(255, 255, 255, 0.5)":"rgba(197, 203, 206, 0.5)"},horzLines:{color:"dark"===t.themeMode?"rgba(255, 255, 255, 0.5)":"rgba(197, 203, 206, 0.5)"}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:"dark"===t.themeMode?"rgba(255, 255, 255, 0.8)":"rgba(197, 203, 206, 0.8)",format:{type:"price",precision:0,minMove:1}},timeScale:{borderColor:"dark"===t.themeMode?"rgba(255, 255, 255, 0.8)":"rgba(197, 203, 206, 0.8)",visible:!1}}),t.candleSeries=t.chart.addSeries(LightweightCharts.CandlestickSeries,{upColor:"redGreen"===t.colorScheme?"#ef5350":"#26a69a",downColor:"redGreen"===t.colorScheme?"#26a69a":"#ef5350",borderDownColor:"redGreen"===t.colorScheme?"#26a69a":"#ef5350",borderUpColor:"redGreen"===t.colorScheme?"#ef5350":"#26a69a",wickDownColor:"redGreen"===t.colorScheme?"#26a69a":"#ef5350",wickUpColor:"redGreen"===t.colorScheme?"#ef5350":"#26a69a",lastValueVisible:!0,priceLineVisible:!0,priceFormat:{type:"price",precision:0,minMove:1}}),window.addEventListener("resize",(()=>{t.chart&&t.chart.applyOptions({width:e.stockChart.clientWidth,height:e.stockChart.clientHeight})})),setTimeout((()=>{const e=document.getElementById("tv-attr-logo");e&&e.remove()}),100),0===t.candles.length){const t=e.stockChart.querySelector(".chart-message");t&&t.remove();const n=document.createElement("div");n.className="chart-overlay",n.id="chartOverlay";const s=document.createElement("div");s.className="chart-overlay-emoji",s.textContent="😱";const a=document.createElement("div");a.className="chart-overlay-message",a.textContent="準備好開始看走勢了嗎";const o=document.createElement("div");o.style.whiteSpace="pre-line",o.className="chart-overlay-hint",o.textContent="點擊「開始」按鈕\n來看你的持倉會如何吧",n.appendChild(s),n.appendChild(a),n.appendChild(o),e.stockChart.appendChild(n)}else d();!function(){e.chartLegend.innerHTML="";[{label:"開盤",id:"legend-open"},{label:"最高",id:"legend-high"},{label:"最低",id:"legend-low"},{label:"收盤",id:"legend-close"},{label:"漲跌",id:"legend-change"}].forEach((t=>{const n=document.createElement("div");n.className="legend-item";const s=document.createElement("span");s.className="legend-label",s.textContent=t.label;const a=document.createElement("span");a.className="legend-value",a.id=t.id,a.textContent="--",n.appendChild(s),n.appendChild(a),e.chartLegend.appendChild(n)}))}()}function o(){if(!t.indicatorSeries||0===t.candles.length)return;const e=[];switch(t.technicalIndicator){case"ma":const n=5;for(let s=0;s<t.candles.length;s++)if(s>=n-1){let a=0;for(let e=0;e<n;e++)a+=t.candles[s-e].close;const o=a/n;e.push({time:t.candles[s].time,value:o})}t.indicatorSeries.setData(e);break;case"ema":const s=2/(5+1);let a=t.candles[0].close;for(let n=0;n<t.candles.length;n++)a=(t.candles[n].close-a)*s+a,e.push({time:t.candles[n].time,value:a});t.indicatorSeries.setData(e);break;case"bollinger":const o=10,l=2,r=[],c=[],i=[];for(let e=0;e<t.candles.length;e++)if(e>=o-1){let n=0;for(let s=0;s<o;s++)n+=t.candles[e-s].close;const s=n/o;let a=0;for(let n=0;n<o;n++){const o=t.candles[e-n].close-s;a+=o*o}const d=Math.sqrt(a/o),m=s+l*d,g=s-l*d;r.push({time:t.candles[e].time,value:m}),c.push({time:t.candles[e].time,value:s}),i.push({time:t.candles[e].time,value:g})}t.indicatorSeries.setData(r),t.indicatorMiddleSeries.setData(c),t.indicatorLowerSeries.setData(i);break;case"volume":for(let n=0;n<t.candles.length;n++){const s=1e3*Math.abs(t.candles[n].close-t.candles[n].open),a=t.candles[n].close>=t.candles[n].open?"redGreen"===t.colorScheme?"#ef5350":"#26a69a":"redGreen"===t.colorScheme?"#26a69a":"#ef5350";e.push({time:t.candles[n].time,value:s,color:a})}t.indicatorSeries.setData(e);break;case"rsi":const d=14,m=[];if(t.candles.length<=d)break;let g=0,u=0;for(let e=1;e<=d;e++){const n=t.candles[e].close-t.candles[e-1].close;n>=0?g+=n:u+=Math.abs(n)}let h=g/d,f=u/d,C=h/(0===f?.001:f),p=100-100/(1+C);m.push({time:t.candles[d].time,value:p});for(let e=d+1;e<t.candles.length;e++){const n=t.candles[e].close-t.candles[e-1].close;let s=0,a=0;n>=0?s=n:a=Math.abs(n),h=(h*(d-1)+s)/d,f=(f*(d-1)+a)/d,C=h/(0===f?.001:f),p=100-100/(1+C),m.push({time:t.candles[e].time,value:p})}t.indicatorSeries.setData(m)}}function l(){if(0===t.candles.length){const t=e.stockChart.querySelector(".chart-message");t&&t.remove()}t.totalClicks++;const n=t.candles.length>0?t.candles[t.candles.length-1].close:t.stockPrice,a=n*(Math.random()*t.volatility*2-t.volatility),l=Math.max(n+a,1),r=new Date,c={open:n,close:l,high:Math.max(n,l)+Math.random()*Math.abs(a)*.5,low:Math.min(n,l)-Math.random()*Math.abs(a)*.5,time:Math.floor(r.getTime()/1e3)};t.candles.push(c),t.candles.length>t.maxCandles&&t.candles.shift(),t.stockPrice=l,t.currentValue=t.shares*t.stockPrice,s(),t.candleSeries&&(t.candleSeries.update(c),"none"!==t.technicalIndicator&&o()),function(e){if(!e)return;const t=document.getElementById("legend-open"),n=document.getElementById("legend-high"),s=document.getElementById("legend-low"),a=document.getElementById("legend-close"),o=document.getElementById("legend-change");t.textContent=formatCurrency(e.open),n.textContent=formatCurrency(e.high),s.textContent=formatCurrency(e.low),a.textContent=formatCurrency(e.close);const l=e.close-e.open,r=l/e.open*100,c=r>0?"+":"";o.textContent=`${c}${l.toFixed(2)} (${c}${r.toFixed(2)}%)`;const i=e.close>e.open,d=r>0;a.className="legend-value "+(i?"profit":e.close<e.open?"loss":""),o.className="legend-value "+(d?"profit":r<0?"loss":"")}(c);showEmojiPopup((l-n)/n*100)}let r=0,c=!1;const i=document.getElementById("cooldownOverlay");function d(){const e=document.getElementById("chartOverlay");e&&(e.classList.add("hidden"),setTimeout((()=>{e&&e.parentNode&&e.parentNode.removeChild(e)}),300))}e.generateCandleBtn.addEventListener("click",(()=>{if(d(),c)return;const n=Date.now();n-r<500||(l(),r=n,1===t.candles.length&&(e.generateCandleBtn.textContent="再來一根！",e.generateCandleBtn.appendChild(i)),c=!0,e.generateCandleBtn.classList.add("cooldown"),i.style.width="0%",setTimeout((()=>{i.style.width="100%"}),50),setTimeout((()=>{c=!1,e.generateCandleBtn.classList.remove("cooldown"),i.classList.add("reset"),i.style.width="0%",setTimeout((()=>{i.classList.remove("reset")}),50)}),1e3))})),e.resetBtn.addEventListener("click",(()=>{if(0===t.candles.length)return void n();e.resetConfirmModal.style.display="flex",e.resetConfirmModal.classList.add("active");const s=t.currentValue-t.initialInvestment,a=s/t.initialInvestment*100;e.resetProfitLoss.textContent=formatCurrency(s),e.resetProfitLoss.className="value "+getProfitLossClass(s),e.resetProfitLossPercentage.textContent=`(${formatPercentage(a)})`,e.resetProfitLossPercentage.className="value percentage "+getProfitLossClass(s),e.resetCandleCount.textContent=t.totalClicks,e.resetMessageNegative.classList.remove("active"),e.resetMessagePositive.classList.remove("active"),e.resetMessageZero.classList.remove("active"),s<0?e.resetMessageNegative.classList.add("active"):s>0?e.resetMessagePositive.classList.add("active"):e.resetMessageZero.classList.add("active")})),e.confirmResetBtn.addEventListener("click",(()=>{const s=t.currentValue-t.initialInvestment,a=s/t.initialInvestment*100,o={initialInvestment:t.initialInvestment,finalValue:t.currentValue,profitLoss:s,profitLossPercentage:a,candleCount:t.totalClicks,lastPrice:t.stockPrice};recordLiquidation(o),showSummaryImage(o),e.resetConfirmModal.style.display="none",e.resetConfirmModal.classList.remove("active"),n()})),e.cancelResetBtn.addEventListener("click",(()=>{e.resetConfirmModal.style.display="none",e.resetConfirmModal.classList.remove("active")})),window.addEventListener("click",(t=>{t.target===e.resetConfirmModal&&(e.resetConfirmModal.style.display="none",e.resetConfirmModal.classList.remove("active"))})),loadSettings(t,e.initialAmountInput,e.colorSchemeSelect,e.themeModeSelect,e.technicalIndicatorSelect,n),s(),setupSettingsEventListeners(e,t,saveSettings,n,l),a(),initStatistics(),setupStatsButton(e.statsBtn)}));